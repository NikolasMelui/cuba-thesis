<?xml version='1.0' encoding='UTF-8'?>
<!-- This document was created with Syntext Serna Free. --><chapter lang="ru" id="chapter3_detail_info">
  <title>Механизмы управления подсистемой безопасности</title>
  <mediaobject>
    <imageobject>
      <imagedata align="center" fileref="img/dbStructure.png"/>
    </imageobject>
    <caption>Структура базы данных подсистемы безопасности</caption>
  </mediaobject>
  <section>
    <title>Окно входа в систему</title>
    <para><classname>Login screen</classname> представляет собой окно входа в систему, посредством которого пользователь получает доступ к системе. В этом окне производится аутентификация пользователя по имени учетной записи и паролю, а также дальнейшая авторизация. Пароль в целях его безопасности хранится в базе данных в хэшированном виде.</para>
    <para>Класс окна входа в систему − <classname>LoginWindow</classname>. </para>
  </section>
  <section>
    <title>Пользовательская сессия</title>
    <para>Пользовательская сессия (User Session) –  центральный элемент обеспечения безопасности, 
объект,  ассоциированный с аутентифицированным в данный момент в системе 
пользователем,  и содержащий информацию о правах доступа пользователя к
данным.</para>
    <para>Для контроля прав доступа пользователей к данным код системы всегда должен иметь возможность узнать, какой пользователь в данный момент работает и каковы его права. Например, перед сохранением сущности в БД в специальных полях сущности проставляется имя пользователя, выполняющего сохранение. Кроме того, <glossterm linkend="glossary_dataService_id">Data Service</glossterm> всегда проверяет права пользователя на извлечение или сохранение определенных сущностей.</para>
    <para>Информация о текущем пользователе и его правах хранится в объекте <classname>UserSession</classname>, который создается после входа  пользователя и кэшируется на стороне <glossterm linkend="glossary_middleware_id">
        <structfield>Middleware</structfield>
      </glossterm>, а также передается клиенту в результате метода <methodname>LoginService.login()</methodname>. Уничтожается пользовательская сессия после выхода пользователя из системы, либо после истечения времени бездействия, определяемого параметром среднего слоя приложения <link linkend="property_sessionExpirTime">cuba.userSessionExpirationTimeoutSec</link>.</para>
    <para>Текущая пользовательская сессия всегда привязывается к потоку выполнения и может быть получена следующими способами:<itemizedlist>
        <listitem>
          <para>через интерфейс инфраструктуры <classname>UserSessionSource</classname></para>
        </listitem>
        <listitem>
          <para>через статический фасад <classname>UserSessionProvider</classname></para>
        </listitem>
      </itemizedlist></para>
    <para>Кроме получения информации о пользователе объект сессии позволяет проверить наличие прав на некоторый объект системы. Делается это вызовом методов <methodname>isScreenPermitted()</methodname>, <methodname>isEntityOpPermitted()</methodname> и другими.</para>
    <para>Список активных пользовательских сессий можно получить на клиенте через сервис <classname>UserSessionService</classname>,  в JMX интерфейсе через МБин <classname>app.cuba:service=UserSessions</classname>, а также с помощью подпункта меню <guimenu>Администрирование</guimenu> −&gt; <guimenu>Пользовательские сессии</guimenu>.</para>
    <mediaobject>
      <imageobject>
        <imagedata align="center" fileref="img/userSession.png"/>
      </imageobject>
    </mediaobject>
  </section>
  <section id="section_roles">
    <title>Роли</title>
    <para>Роль − это объект системы, которому с одной стороны сопоставляется набор полномочий, необходимых для выполнения конкретных функций, а с другой стороны − подмножество пользователей, которые должны иметь эти полномочия.</para>
    <para>Пользователь получает логическую сумму прав на некоторый объект от всех ролей, которые у него есть. При этом если ни одна роль не определяет явно право на объект, то пользователь получает право на этот объект. Таким образом,  пользователь имеет права на все объекты, на которые либо ни одна роль явно не определяет право, либо хотя бы одна роль определяет, что право есть. Отсюда следует, что если пользователю дать единственную роль без явно установленных прав или не давать никаких ролей вообще, то у него будут все права на все объекты.</para>
    <para>Для роли возможно указание одного из следующих типов:<itemizedlist>
        <listitem>
          <para><emphasis role="bold">STANDARD</emphasis> − в роли данного типа действуют только явно назначенные разрешения.</para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">SUPER</emphasis> − роль данного типа автоматически дает все разрешения. Это удобно для назначения администраторов системы.</para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">READONLY</emphasis> − роль данного типа автоматически отнимает разрешения на следующие операции с сущностями: CREATE, UPDATE, DELETE.</para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">DENYING</emphasis> − роль данного типа автоматически отнимает разрешения на все объекты, кроме атрибутов сущностей.</para>
        </listitem>
      </itemizedlist></para>
    <mediaobject>
      <imageobject>
        <imagedata align="center" fileref="img/permissions.png"/>
      </imageobject>
    </mediaobject>
    <para>Путем задания для пользователя набора ролей в экранах управления подсистемой безопасности осуществляется настройка прав доступа. Набор ролей определяет эффективный набор разрешений следующих типов: <itemizedlist id="permissions_types_id">
        <listitem>
          <para>Возможность открытия некоторого экрана (Screen Permissions)</para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/screenPermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
        <listitem>
          <para>Возможность операции над некоторой сущностью:  чтение,  создание, 
модификация, удаление (Entity Operation Permissions)</para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/entityoperationPermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
        <listitem>
          <para>Доступ к произвольному атрибуту некоторой сущности:  модификация, 
только чтение, нет доступа (Entity Attribute Permissions)</para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/entityattributePermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
        <listitem id="specific_permissions">
          <para>Разрешение на некоторую именованную функциональность (Specific Permissions). Эти разрешения задаются в файлах, которые указаны в свойстве <parameter>cuba.permissionConfig</parameter> <glossterm linkend="glossary_app_properties_id">файла свойств</glossterm> приложения. Пример файла <filename>cuba-web-permissions.xml</filename>:</para>
          <para><programlisting>&lt;permission-config&gt;

    &lt;specific&gt;

        &lt;category id=&quot;cuba&quot;&gt;
            &lt;category id=&quot;cuba.gui&quot;&gt;
                &lt;permission id=&quot;cuba.gui.showInfo&quot;/&gt;
                &lt;category id=&quot;cuba.gui.filter&quot;&gt;
                    &lt;permission id=&quot;cuba.gui.filter.global&quot;/&gt;
                    &lt;permission id=&quot;cuba.gui.filter.edit&quot;/&gt;
                    &lt;permission id=&quot;cuba.gui.filter.customConditions&quot;/&gt;
                    &lt;permission id=&quot;cuba.gui.filter.maxResults&quot;/&gt;
                &lt;/category&gt;
                &lt;permission id=&quot;cuba.gui.searchFolder.global&quot;/&gt;
                &lt;permission id=&quot;cuba.gui.presentations.global&quot;/&gt;
                &lt;permission id=&quot;cuba.gui.appFolder.global&quot;/&gt;
            &lt;/category&gt;
        &lt;/category&gt;
        
    &lt;/specific&gt;

&lt;/permission-config&gt;</programlisting></para>
          <para>Названия свойств задаются в главном файле локализации соответствующего проекта. Например, для указанного выше файла <glossterm linkend="glossary_localized_folders_id">локализация</glossterm> названий на русский язык задается в файле <filename>messages_ru.properties</filename> пакета <package>com.haulmont.cuba.gui</package></para>
          <para><programlisting>permission-config.cuba=CUBA
permission-config.cuba.gui=Generic UI
permission-config.cuba.gui.showInfo=Системная информация
permission-config.cuba.gui.filter=Фильтр
permission-config.cuba.gui.filter.global=Создание/изменение глобальных фильтров
permission-config.cuba.gui.filter.edit=Создание/изменение фильтров
permission-config.cuba.gui.filter.customConditions=Создание/изменение настраиваемых условий
permission-config.cuba.gui.filter.maxResults=Неограниченное число строк
permission-config.cuba.gui.searchFolder.global=Создание/изменение глобальных папок поиска
permission-config.cuba.gui.presentations.global=Создание/изменение глобальных представлений
permission-config.cuba.gui.appFolder.global=Создание/изменение папок приложения
</programlisting></para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/specificpermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
        <listitem>
          <para>Управление доступом к конкретным элементам экрана (Interface Permissions)</para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/interfacePermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
      </itemizedlist></para>
  </section>
  <section id="section_access_groups">
    <title>Группы доступа</title>
    <para>Группы доступа предоставляют инструмент назначения ограничений доступа к определенным экземплярам сущностей (записям). Пользователь может быть причислен только к одной группе, однако он получит список ограничений от всех групп вверх по иерархии.</para>
    <para id="constraints_id">Ограничения задаются с помощью фрагментов выражений на языке <link linkend="glossary_jpql_id">JPQL</link>. </para>
    <para>В параметрах ограничений  можно использовать следующие предопределенные константы:<itemizedlist>
        <listitem>
          <para><varname>session$userLogin</varname> − имя учетной записи текущего пользователя (в случае замещения − имя учетной записи замещаемого пользователя).</para>
        </listitem>
        <listitem>
          <para><varname>session$userId</varname> − ID текущего пользователя (в случае замещения − ID замещаемого пользователя).</para>
        </listitem>
        <listitem>
          <para><varname>session$userGroupId</varname> − ID группы текущего пользователя (в случае замещения − ID группы замещаемого пользователя).</para>
        </listitem>
        <listitem>
          <para><varname>session$XXX</varname> − атрибут текущей пользовательской сессии, где XXX - имя атрибута</para>
        </listitem>
      </itemizedlist></para>
    <mediaobject>
      <imageobject>
        <imagedata align="center" fileref="img/accessGroups.png"/>
      </imageobject>
    </mediaobject>
    <para>Следует иметь в виду следующие моменты:<itemizedlist>
        <listitem>
          <para>при задании только оператора Where в нем заменяется алиас основной сущности;</para>
        </listitem>
        <listitem>
          <para>при задании и оператора Join, и оператора Where, в операторе Join алиас заменяется, а в операторе Where нет.</para>
        </listitem>
      </itemizedlist></para>
    <para>В обоих случаях в текст оператора Join и оператора Where можно помещать метку {E}, которая будет заменена на алиас основной сущности запроса. Если в тексте встречается метка {E}, то никаких других алиасов, кроме указанных меткой, заменяться не будет.</para>
    <para>Пример создания ограничений находится в <link linkend="example_access_group">главе 4</link>.</para>
    <para id="detail_session_attr"><emphasis role="bold">Session Attributes</emphasis></para>
    <para>Атрибуты пользовательской сессии могут быть заданы при настройке системы. Это может понадобиться при настройке constraints, а также для любой другой прикладной функциональности.</para>
    <para>В пользовательскую сессию при входе в систему будут помещены все атрибуты, заданные для группы, в которой находится пользователь, и для всех родительских групп вверх по иерархии. При этом если атрибут встречается в иерархии групп несколько раз, значение он получит от самой верхней группы, то есть переопределение значений атрибутов на нижнем уровне невозможно. При попытке переопределения в лог сервера будет выведено сообщение с уровнем WARN.</para>
  </section>
  <section id="section_IP">
    <title>Ограничение входа по IP</title>
    <para>Для пользователя может быть задана маска допустимых IP-адресов, с которых возможен вход в систему.</para>
    <para>Маска представляет собой список адресов через запятую. Каждый адрес должен обязательно состоять из 4-х чисел разделенных точками (обычный формат IPv4). При этом любая часть вместо числа может содержать знак &quot;*&quot;, что означает &quot;любое число&quot;. </para>
    <mediaobject>
      <imageobject>
        <imagedata align="center" fileref="img/IPpermissions.png"/>
      </imageobject>
    </mediaobject>
    <para>Если маска задана неправильно, либо для данного соединения не может быть определен адрес в формате IPv4, в лог выводится сообщение от логгера <classname>IpMatcher</classname>, и вход при этом разрешается.</para>
  </section>
  <section id="section_AD">
    <title>Интеграция с Active Directory</title>
    <para><firstterm>Active Directory</firstterm> −  это LDAP-совместимая реализация службы каталогов <application>Microsoft</application> для операционных систем семейства <application>Windows</application>, которая позволяет администраторам реализовать наборы правил, в соответствии с которыми обеспечивается единообразие настройки пользовательской среды, развертывать программное обеспечение на большом количестве компьютеров, устанавливать обновления на всех компьютерах сети. <application>Active Directory</application> хранит данные и настройки среды в централизованной базе данных.  Более подробно об <application>Active Directory</application> Вы сможете прочитать, перейдя по следующей ссылке:  <ulink url="http://ru.wikipedia.org/wiki/Active_Directory">http://ru.wikipedia.org/wiki/Active_Directory</ulink></para>
    <para id="domainController"><firstterm>Domain Controller</firstterm> − сервер, контролирующий область компьютерной сети (домен). В сетях <application>Microsoft</application> это центральный сервер для <application>Active Directory</application>.</para>
    <para><firstterm>Kerberos</firstterm> − сетевой протокол аутентификации, позволяющий передавать данные через незащищенные сети для безопасной идентификации. Вместо передачи паролей в открытом виде в нем используется шифрование с ключами. <application>Kerberos</application> предоставляет дополнительный уровень безопасности системы и сильно усложняет перехват паролей пользователей злоумышленниками.</para>
    <para><firstterm>NTLM</firstterm> − протокол сетевой аутентификации, разработанный фирмой <application>Microsoft</application> для <application>Windows NT</application>.</para>
    <para id="para_sso"><firstterm>Технология единого входа (Single Sign-On)</firstterm> − технология, при использовании которой пользователь переходит от одного приложения к другому без повторной аутентификации.</para>
    <para><firstterm>HTTP 401</firstterm> − код протокола <application>HTTP</application>, запрос авторизации.</para>
    <para><firstterm>HTTP 400</firstterm> − код протокола <application>HTTP</application>,  неверный запрос, синтаксическая ошибка <application>HTTP</application> или превышение максимального размера запроса.</para>
    <para><firstterm>Service Principal Name (SPN)</firstterm> − имя службы, включающее в себя имя протокола, адрес веб-сервера и порт (если он не является стандартным для этого протокола).</para>
    <para><firstterm>Jespa</firstterm> −  библиотека для <application>Java</application>, обеспечивающая расширенную интеграцию между службой каталогов <application>Active Directory</application> и Java-приложениями.</para>
    <section>
      <title>Настройка Kerberos аутентификации</title>
      <section>
        <title>Мотивация</title>
        <para>Настройка <application>Kerberos</application> вызывает определенные проблемы из-за множества параметров и специфики <application>Windows</application>, но, вместе с тем, у этого алгоритма аутентификации есть ряд преимуществ.</para>
        <para><application>Kerberos</application> является надежным средством контроля доступа и широко применяется как в <application>Windows</application>, так и в <application>Linux</application> средах. На данный момент в нем не найдено уязвимостей уровня протокола, и он позволяет использовать сильное шифрование (<application>RC4</application>, <application>AES</application>). Все продукты <application>Microsoft</application> поддерживают <application>Kerberos</application> аутентификацию и в будущем от него не планируют отказываться.</para>
        <para>Аутентификация в нашей системе для провайдера <application>Kerberos</application> выполняется всего один раз, в дальнейшем сессия пользователя хранит информацию об удачном входе и не требуется заново опрашивать сервер <application>Active Directory</application>. Это позволяет не терять производительность при аутентификации на каждый запрос и упрощает анализировать  файлы логов.</para>
      </section>
      <section>
        <title>Как это работает</title>
        <para><emphasis role="bold">Этапы автоматической аутентификации</emphasis></para>
        <itemizedlist>
          <listitem>
            <para>Запрос страницы с веб-сервера от клиента</para>
          </listitem>
          <listitem>
            <para>Веб-сервер возвращает код 401 (требование авторизации), и в содержимом ответа содержится строка <userinput>Negotiate</userinput></para>
          </listitem>
          <listitem>
            <para>Клиент по доменному имени веб-сервера выясняет у <link linkend="domainController">Domain Controller</link> имя соответствующей веб-службы</para>
          </listitem>
          <listitem>
            <para>Клиент выполняет процедуру получения тикета для <application>Kerberos</application> аутентификации, для этого обращаясь к сервису <application>Kerberos</application> на <link linkend="domainController">Domain Controller</link>  или отдельному Key Distribution Center серверу</para>
          </listitem>
          <listitem>
            <para>Клиент вновь выполняет запрос, помещая в заголовки строку <userinput>Authorization: Negotiate &lt;Тикет Kerberos&gt;</userinput></para>
          </listitem>
          <listitem>
            <para>Веб-сервер входит в систему от имени службы и пытается получить по тикету клиента его имя у <link linkend="domainController">Domain Controller</link></para>
          </listitem>
          <listitem>
            <para>При удачном получении имени клиента ему в сессию добавляется переменная, содержащая имя, полученное от <link linkend="domainController">Domain Controller</link></para>
          </listitem>
          <listitem>
            <para>Выполняется поиск пользователя в базе данных приложения и, если он найден, выполняется вход в систему.</para>
          </listitem>
        </itemizedlist>
        <warning>
          <para>В базе данных имена пользователей <application>Active Directory</application> хранятся как <userinput>&lt;domain.zone&gt;\user</userinput></para>
        </warning>
        <para>Попытка автоматического входа в систему для каждого пользователя всего одна. Если она завершается неудачно, то сессия помечается как неподдерживаемая и выводиться обычная форма входа в систему. Если пользователь уже вошел в приложение, то всего его запросы свободно пропускаются (есть живая сессия), и дополнительных обращений к <link linkend="domainController">Domain Controller</link> не требуется.</para>
        <para><emphasis role="bold">Этапы аутентификации при входе через стартовую форму приложения</emphasis></para>
        <itemizedlist>
          <listitem>
            <para>Веб-сервер определяет домен, соответствующий псевдониму, введенному пользователем: <userinput>&lt;alias&gt;\&lt;user&gt;</userinput> −&gt; <userinput>&lt;DOMAIN.ZONE&gt;\user</userinput></para>
          </listitem>
          <listitem>
            <para>Выполняется вход в систему от имени пользователя</para>
          </listitem>
          <listitem>
            <para>Если вход удачен, выполняется поиск пользователя в базе данных приложения</para>
          </listitem>
          <listitem>
            <para>Если пользователь зарегистрирован в системе, выполняется вход в систему</para>
          </listitem>
        </itemizedlist>
      </section>
      <section>
        <title>Настройка доменного контроллера для использования аутентификации Kerberos</title>
        <para>В примере используются следующие данные:</para>
        <itemizedlist>
          <listitem>
            <para>Доменное имя веб-сервера: <userinput>win-web2008-art</userinput></para>
          </listitem>
          <listitem>
            <para>Доменный контроллер: <userinput>dc.haulmont.com</userinput></para>
          </listitem>
        </itemizedlist>
        <para>Алгоритм настройки:</para>
        <itemizedlist>
          <listitem>
            <para>Создать доменного пользователя <userinput>winkdc</userinput>, задать пароль и установить опции <guilabel>Срок действия пароля не истекает</guilabel> и <guilabel>Запретить пользователю изменять пароль</guilabel></para>
          </listitem>
          <listitem>
            <para>Задать соответствие имени пользователя и имени сервиса</para>
            <para><prompt>setspn -A http/win-web2008-art.haulmont.com winkdc</prompt></para>
          </listitem>
          <listitem>
            <para>Для входа в систему от имени пользователя <userinput>winkdc</userinput> на стороне веб-сервера используется файл ключа (не используется парольная аутентификация)</para>
            <para><prompt>ktpass -princ http/win-web2008-art.haulmont.com@HAULMONT.COM -pass 3edc$RFV5tgb -mapuser winkdc -out winkdc.keytab -ptype KRB5_NT_PRINCIPAL -kvno 0</prompt></para>
          </listitem>
          <listitem>
            <para>На выходе в текущей папке появится файл <filename>winkdc.keytab</filename>, его нужно сохранить для использования на веб-сервере.</para>
          </listitem>
        </itemizedlist>
      </section>
      <section>
        <title>Настройка конфигурации веб-сервера</title>
        <itemizedlist>
          <listitem>
            <para>Файл конфигурации домена <filename>krb5.ini</filename>. По умолчанию размещается в <filename>${catalina.home}/conf/${cuba.webContextName}/krb5.ini</filename>. В этом файле указывается имя домена и расположение доменного контроллера.</para>
            <para><programlisting>[libdefaults]
default_realm = HAULMONT.COM
default_tgs_enctypes = rc4-hmac
default_tkt_enctypes = rc4-hmac
permitted_enctypes = rc4-hmac des-cbc-md5

[domain_realm]
.win-web2008-art.haulmont.com = HAULMONT.COM
win-web2008-art.haulmont.com = HAULMONT.COM
.haulmont.com = HAULMONT.COM
haulmont.com = HAULMONT.COM

[realms]
HAULMONT.COM = {
  kdc = dc.haulmont.com
  admin_server = dc.haulmont.com
  default_domain = haulmont.com
}

[appdefaults]
autologin = true
forward = true
forwardable = true
encrypt = true </programlisting></para>
          </listitem>
          <listitem>
            <para>Файл конфигурации сервиса <filename>jaas.conf</filename>.  По умолчанию размещается в <filename>${catalina.home}/conf/${cuba.webContextName}/jaas.conf</filename>. В этом файле задается имя сервиса и путь к файлу ключа.</para>
            <para><programlisting>HAULMONT.COM{
com.sun.security.auth.module.Krb5LoginModule required
useKeyTab=true
doNotPrompt=true
storeKey=true
keyTab=&quot;c:/work/kdc/winkdc.keytab&quot;
useTicketCache=false
isInitiator=false
principal=&quot;http/win-web2008-art.haulmont.com@HAULMONT.COM&quot;;
};

AUTH.HAULMONT.COM{
com.sun.security.auth.module.Krb5LoginModule required
doNotPrompt=false
client=true
useTicketCache=false;};</programlisting></para>
          </listitem>
          <listitem>
            <para>Файл ключа нужно разместить по адресу, указанному в <filename>jaas.conf</filename> (желательно в той же папке, что и файл ключа).</para>
          </listitem>
          <listitem>
            <para>Настройки приложения <glossterm linkend="glossary_local_app_properties_id">local.app.properties</glossterm>.  По умолчанию для <application>Active Directory</application> используются следующие настройки:</para>
            <para><programlisting># Использовать Kerberos
cuba.web.activeDirectoryAuthClass=com.haulmont.cuba.web.sys.auth.KerberosAuthProvider
# Файлы конфигурации расположены в каталоге conf приложения
cuba.web.kerberosConf=${catalina.home}/conf/${cuba.webContextName}/krb5.ini
cuba.web.kerberosJaasConf=${catalina.home}/conf/${cuba.webContextName}/jaas.conf   </programlisting></para>
            <para>Для использования <application>Kerberos</application> необходимо задать следующее:</para>
            <para><programlisting># Разрешить использование Active Directory
cuba.web.useActiveDirectory=false
# Название модуля конфигурации для автоматического входа
cuba.web.kerberosLoginModule=HAULMONT.COM
# Название модуля конфигурации для входа по имени и паролю
cuba.web.kerberosAuthModule=AUTH.HAULMONT.COM</programlisting></para>
          </listitem>
        </itemizedlist>
      </section>
      <section>
        <title>Работа формы входа приложения</title>
        <para>По умолчанию форма входа используется:</para>
        <itemizedlist>
          <listitem>
            <para>При входе из внешней сети</para>
          </listitem>
          <listitem>
            <para>Для неподдерживаемых клиентов (<application>Linux</application>, <application>Mac OS</application>, мобильные клиенты)</para>
          </listitem>
          <listitem>
            <para>Для клиентов, не входящих в состав домена</para>
          </listitem>
          <listitem>
            <para>При неудачной попытке автоматического входа (неверный <application>SPN</application>, кэшированный тикет <application>Kerberos</application>)</para>
          </listitem>
        </itemizedlist>
        <para>Для входа под доменным аккаунтом необходимо ввести имя в одном из форматов: <userinput>&lt;DOMAIN.ZONE&gt;\&lt;USER&gt;</userinput> или <userinput>&lt;USER&gt;@&lt;DOMAIN.ZONE&gt;</userinput>. В поле <guilabel>Пароль</guilabel> − свой доменный пароль, он не хранится в системе, используется только при входе. </para>
        <para>Для <userinput>&lt;DOMAIN.ZONE&gt;</userinput> могут быть настроены псевдонимы (например, если имя домена длинное или незапоминающееся)</para>
        <para><programlisting>cuba.web.activeDirectoryAliases=haulmont|HAULMONT.COM;dc|SOMEDOMAIN.ZONE</programlisting></para>
        <para>Если для какого-то домена задан псевдоним <userinput>alias</userinput>, то в форме входа достаточно ввести <userinput>alias/&lt;USER&gt;</userinput> или <userinput>&lt;USER&gt;@alias</userinput></para>
      </section>
      <section>
        <title>Настройка клиентских машин</title>
        <para><emphasis role="bold">Добавление веб-сервера в зону интранет</emphasis></para>
        <para>Откройте приложение <application>Internet Explorer</application>. Далее перейдите к пункту меню <guimenu>Сервис</guimenu> −&gt; <guimenu>Свойства обозревателя</guimenu>. В открывшемся окне выберите  вкладку <guilabel>Безопасность</guilabel>. Дальнейшие действия приведены на рисунке ниже.</para>
        <mediaobject>
          <imageobject>
            <imagedata align="center" fileref="img/TrustedZoneUrls.png"/>
          </imageobject>
        </mediaobject>
        <para><emphasis role="bold">Разрешение автоматического входа в зоне интранет</emphasis></para>
        <para>Откройте приложение <application>Internet Explorer</application>. Далее перейдите к пункту меню <guimenu>Сервис</guimenu> −&gt; <guimenu>Свойства обозревателя</guimenu>. В открывшемся окне выберите  вкладку <guilabel>Безопасность</guilabel>. Дальнейшие действия приведены на рисунке ниже.</para>
        <mediaobject>
          <imageobject>
            <imagedata align="center" fileref="img/AutoLogin.png"/>
          </imageobject>
        </mediaobject>
        <para><emphasis role="bold">Разрешение встроенной проверки подлинности Windows</emphasis></para>
        <para>Откройте приложение <application>Internet Explorer</application>. Далее перейдите к пункту меню <guimenu>Сервис</guimenu> −&gt; <guimenu>Свойства обозревателя</guimenu>. В открывшемся окне выберите  вкладку <guilabel>Дополнительно</guilabel>. Дальнейшие действия приведены на рисунке ниже.</para>
        <mediaobject>
          <imageobject>
            <imagedata align="center" fileref="img/WindowsAuth.png"/>
          </imageobject>
        </mediaobject>
        <para>Разрешение типов шифрования для рабочих станций с операционной системой <application>Windows 7</application>.</para>
        <para>Данные действия требуются в том случае, если на рабочей станции заданы требуемые типы шифрования. По умолчанию разрешены все.
Используется <userinput>logon</userinput> скрипт, добавляющий разрешения на типы шифрования в реестр:</para>
        <para><programlisting>@echo off
reg add &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters&quot; 
/v SupportedEncryptionTypes /t REG_DWORD /d 0x7fffffff /f</programlisting></para>
        <para>Также этот параметр можно настроить в параметрах: 
<guimenu>Панель управления</guimenu> −&gt;<guimenu>Администрирование</guimenu> −&gt; <guimenu>Локальная политика безопасности</guimenu> −&gt; <guimenu>Локальные политики</guimenu> −&gt; <guimenu>Параметры безопасности</guimenu> −&gt; <guimenu>Сетевая безопасность: настройка типов шифрования, разрешенных Kerberos</guimenu></para>
        <para><emphasis role="bold">Настройка Internet Explorer и Chrome</emphasis></para>
        <para>Отдельных настроек не требуется, используются настройки системы.</para>
        <para><emphasis role="bold">Настройка Firefox</emphasis></para>
        <para>Откройте приложение <application>Mozilla Firefox</application>. В адресной строке введите <userinput>about:config</userinput>. Далее найдите ключи <userinput>network.negotiate-auth.trusted-uris</userinput> и <userinput>network.negotiate-auth.delegation-uris</userinput> и добавьте в список адресов адрес сервера.</para>
        <mediaobject>
          <imageobject>
            <imagedata align="center" fileref="img/FireFoxNego.png"/>
          </imageobject>
        </mediaobject>
      </section>
      <section>
        <title>Возможные проблемы и их решения</title>
        <itemizedlist>
          <listitem>
            <para>Невозможность автоматического входа с машины, на которой запущен веб-сервер. Проблема связана с ограничениями <application>Kerberos</application>, вход выполняется через обычную форму входа приложения.</para>
          </listitem>
          <listitem>
            <para>Необходимость создания пользователя для сервиса.</para>
          </listitem>
          <listitem>
            <para>Клиентская машина должна быть включена в домен.</para>
          </listitem>
          <listitem>
            <para>Доступ из внешней сети осуществляется через обычную форму входа приложения.</para>
          </listitem>
        </itemizedlist>
        <warning>
          <para>Выслушайте опытного администратора, если он сомневается в Ваших действиях и настройках для <application>Active Directory</application>. 
Если сомнения обоснованы, уточните информацию у разработчика.</para>
        </warning>
        <para><emphasis role="bold">Включение полной отладочной информации на сервере</emphasis></para>
        <itemizedlist>
          <listitem>
            <para>Для включения отладочной информации <application>Kerberos</application> на сервере в <glossterm linkend="glossary_local_app_properties">local.app.properties</glossterm> задать параметр </para>
            <para><programlisting>cuba.web.activeDirectoryDebug = true</programlisting></para>
          </listitem>
          <listitem>
            <para>В параметрах логгирования <emphasis role="bold">log4j</emphasis> выставить группе <emphasis role="bold">com.haulmont.cuba.web.sys</emphasis> уровень <emphasis role="bold">DEBUG</emphasis></para>
          </listitem>
        </itemizedlist>
        <para><emphasis role="bold">Белый экран в браузере</emphasis></para>
        <para>Значит, при попытке аутентификации браузер не знает, что делать с 401 кодом <application>HTTP</application>.

Ошибки:</para>
        <itemizedlist>
          <listitem>
            <para>Не разрешен автоматический вход в сети интранет</para>
          </listitem>
          <listitem>
            <para>Вы используете ненастроенный браузер <application>Firefox</application></para>
          </listitem>
          <listitem>
            <para>Неверная запись <application>SPN</application> для веб-сервера</para>
          </listitem>
        </itemizedlist>
        <para><emphasis role="bold">Ошибка 400</emphasis></para>
        <para>В сервере <application>Tomcat</application> по умолчанию задан максимальный размер заголовков запроса: 8192 байт. Тикет <application>Kerberos</application> для отдельных пользователей может превышать этот размер.</para>
        <para>В <filename>server.xml</filename> необходимо установить для <parameter>Connector</parameter> значение <parameter>maxHttpHeaderSize</parameter> в большее значение, 16536 или  32768.</para>
        <warning>
          <para>Если вы используете <application>NIO Connector</application> и <application>Tomcat 6</application>, то Вы не сможете настроить <parameter>maxHttpHeaderSize</parameter>. 
Решение − перейти на <application>Tomcat 7</application>.</para>
        </warning>
        <para><emphasis role="bold">Неверный SPN</emphasis></para>
        <para>Следует очень аккуратно подходить к назначению <application>SPN</application> для сервиса, много проблем связано с неверным <application>SPN</application>. </para>
        <itemizedlist>
          <listitem>
            <para><application>SPN</application> можно назначать и удалять утилитой <application>setspn</application>, при помощи нее можно находить дубликаты <application>SPN</application> при помощи ключа <parameter>-X</parameter>. </para>
          </listitem>
          <listitem>
            <para>Также <parameter>SPN</parameter> можно редактировать напрямую в <application>Active Directory</application> через <application>LDAP</application> интерфейс, например <application>LDAP Browser</application>.  
Множество параметров <parameter>servicePrincipalName</parameter> задают записи <application>SPN</application> для аккаунта пользователя. 
Параметр <parameter>userPrincipalName</parameter> задает имя пользователя как службы. </para>
          </listitem>
        </itemizedlist>
        <para><emphasis role="bold">Агрессивное кэширование тикетов на клиентских машинах</emphasis></para>
        <para>Тикеты <application>Kerberos</application> довольно агрессивно кэшируются, это позволяет достигать большей производительности в больших лесах <application>Active Directory</application>. В связи с этим могут возникнуть проблемы при смене <application>SPN</application>, так как все тикеты должны ему соответствовать. </para>
        <para>В итоге сервер может отвергать тикеты с ошибкой <errorname>Caused by: GSSException: Failure unspecified at GSS-API level (Mechanism level: Checksum failed)</errorname></para>
        <para>Для сброса кэша <application>Kerberos</application> на клиентской машине следует использовать специальную программу <application>kerbtray.exe</application> из <application>Microsoft Windows Server 2003 Resource Kit Tools</application> (<ulink url="http://www.microsoft.com/en-us/download/details.aspx?id=17657">http://www.microsoft.com/en-us/download/details.aspx?id=17657</ulink>)</para>
        <para>После запуска программа появляется в трее <application>Windows</application>, для сброса кэша нужно воспользоваться пунктом <guilabel>Purge Tickets</guilabel> в контекстном меню.</para>
        <mediaobject>
          <imageobject>
            <imagedata align="center" fileref="img/KerbTray.png"/>
          </imageobject>
        </mediaobject>
        <para><emphasis role="bold">Клиентская машина высылает тикет, начинающийся с TIRMT</emphasis></para>
        <para>При ошибке аутентификации в логах остается отметка с уровнем WARN и распечаткой тикета. По нему можно определить тип аутентификации, который использует клиент. </para>
        <para>Тикеты <application>NTLM</application> начинаются с приставки <emphasis role="bold">TIRMT</emphasis>.</para>
        <para>Тикеты <application>Kerberos</application> начинаются с приставки <emphasis role="bold">YI</emphasis>.</para>
        <itemizedlist>
          <listitem>
            <para>Это значит, что машина не может определить, что для данного доменного имени есть сервис, и высылает тикет <application>NTLM</application> <errorname>Неверно задан SPN</errorname></para>
          </listitem>
          <listitem>
            <para>Машина может быть не введена в домен</para>
          </listitem>
          <listitem>
            <para>Редакция <application>Windows</application> не позволяет использование корпоративных сетей. Например, <application>Home Premium</application>.</para>
          </listitem>
          <listitem>
            <para>Отсутствует соединение с сервером <application>Active Directory</application></para>
          </listitem>
          <listitem>
            <para>Это нормальное поведение при доступе извне, в таком случае будет выводиться стандартная форма входа в систему.</para>
          </listitem>
        </itemizedlist>
        <para><emphasis role="bold">Используется не Windows клиент</emphasis></para>
        <para>Для таких клиентских машин автоматический вход не поддерживается. 
Пользователю будет выведена форма входа приложения, а в переменные сессии будет добавлен параметр <parameter>ADIntegrationSupport</parameter> со значением <parameter>false</parameter>.</para>
      </section>
      <section>
        <title>Дополнительные материалы</title>
        <itemizedlist>
          <listitem>
            <para>Alfresco Kerberos manual (<ulink url="http://wiki.alfresco.com/wiki/Alfresco_Authentication_Subsystems#Kerberos">http://wiki.alfresco.com/wiki/Alfresco_Authentication_Subsystems#Kerberos</ulink>)</para>
          </listitem>
          <listitem>
            <para>WebLogic Server Trouble shooting (<ulink url="http://weblogic-wonders.com/weblogic/2010/01/07/troubleshooting-kerberos-issues-with-weblogic-server">http://weblogic-wonders.com/weblogic/2010/01/07/troubleshooting-kerberos-issues-with-weblogic-server</ulink>)</para>
          </listitem>
          <listitem>
            <para>Kerberos tools klist, kerbtray (<ulink url="http://www.microsoft.com/en-us/download/details.aspx?id=17657">http://www.microsoft.com/en-us/download/details.aspx?id=17657</ulink>)</para>
          </listitem>
          <listitem>
            <para>IBM Lotus Domino SPN (<ulink url="http://publib.boulder.ibm.com/infocenter/domhelp/v8r0/index.jsp?topic=%2Fcom.ibm.help.domino.admin85.doc%2FH_ESTABLISH_AN_SPN_IN_ACTIVE_DIRECTORY_FOR_THE_DOMINO_SERVER_STEPS.html">http://publib.boulder.ibm.com/infocenter/domhelp/v8r0/index.jsp?topic=%2Fcom.ibm.help.domino.admin85.doc%2FH_ESTABLISH_AN_SPN_IN_ACTIVE_DIRECTORY_FOR_THE_DOMINO_SERVER_STEPS.html</ulink>)</para>
          </listitem>
          <listitem>
            <para>SetSPN Documentation (<ulink url="http://technet.microsoft.com/en-us/library/cc731241%28WS.10%29.aspx">http://technet.microsoft.com/en-us/library/cc731241%28WS.10%29.aspx</ulink>)</para>
          </listitem>
          <listitem>
            <para>SPNEGO - Kerberos SSO for Tomcat (<ulink url="http://spnego.sourceforge.net/">http://spnego.sourceforge.net/</ulink>)</para>
          </listitem>
          <listitem>
            <para>How Clients Compose a Service&apos;s SPN (<ulink url="http://msdn.microsoft.com/en-us/library/windows/desktop/ms676924%28v=vs.85%29.aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/ms676924%28v=vs.85%29.aspx</ulink>)</para>
          </listitem>
        </itemizedlist>
      </section>
    </section>
    <section>
      <title>Настройка NTLM аутентификации с использованием Jespa</title>
      <para><firstterm>Jespa</firstterm> − библиотека для <application>Java</application>, обеспечивающая расширенную интеграцию между службой каталогов <application>Active Directory</application> и Java-приложениями. <application>Jespa</application> содержит  классы, обеспечивающие выполнение самых разнообразных функций, связанных с безопасностью: аутентификацию, создание учетных записей, настройку паролей и многое другое. <application>Jespa</application> включает в себя несколько готовых к использованию компонентов для выполнения различных функций, например, для Enterprise Single Sign-On (SSO) аутентификации для HTTP-приложений. Более подробно о данной библиотеке Вы можете прочитать на сайте <ulink url="http://www.ioplex.com/">http://www.ioplex.com/</ulink>.</para>
      <para>Алгоритм настройки:</para>
      <itemizedlist>
        <listitem>
          <para>Создать в <application>ActiveDirectory</application> компьютер, например, с именем <userinput>JESPA</userinput></para>
        </listitem>
        <listitem>
          <para>Создать и запустить скрипт <filename>SetComputerPass.vbs</filename> и задать пароль</para>
          <para><programlisting>Option Explicit

Dim strDn, objPassword, strPassword, objComputer

If WScript.arguments.count &lt;&gt; 1 Then
WScript.Echo &quot;Usage: SetComputerPass.vbs &lt;ComputerDN&gt;&quot;
WScript.Quit
End If

strDn = WScript.arguments.item(0)

Set objPassword = CreateObject(&quot;ScriptPW.Password&quot;)
WScript.StdOut.Write &quot;Password:&quot;
strPassword = objPassword.GetPassword()

Set objComputer = GetObject(&quot;LDAP://&quot; &amp; strDn)
objComputer.SetPassword strPassword

WScript.Quit
</programlisting></para>
          <para>либо отредактировать <filename>SetComputerPassSimple.vbs</filename> и запустить.</para>
          <para><programlisting>Set objComputer = GetObject(&quot;LDAP://CN=JESPA,CN=Computers,DC=haulmont,DC=com&quot;)
objComputer.SetPassword &quot;put_your_passsword_here&quot;

WScript.Quit</programlisting></para>
          <para>Если скрипт не работает на сервере, войдите через учетную запись администратора на  компьютер под управлением операционной системы <application>Windows XP</application> и запустите скрипт там.</para>
          <para><prompt>cscript SetComputerPass.vbs CN=JESPA,CN=Computers,DC=haulmont,DC=com</prompt></para>
        </listitem>
        <listitem>
          <para>Задать параметры доменов в <glossterm linkend="glossary_local_app_properties">local.app.properties</glossterm> в переменной <prompt>cuba.web.activeDirectoryDomains</prompt>. Каждый описатель домена имеет формат <prompt>domain_name|full_domain_name|service_account_name|service_account_password</prompt>. Описатели доменов отделяются друг от друга точкой с запятой. Например:</para>
          <para><prompt>cuba.web.activeDirectoryDomains=HAULMONT|haulmont.com|JESPA$@HAULMONT.COM|password1; TEST|test.com|JESPA$@TEST.COM|password2</prompt></para>
        </listitem>
        <listitem>
          <para>Задать в <glossterm linkend="glossary_local_app_properties">local.app.properties</glossterm> дополнительные свойства для библиотеки <application>Jespa</application> (<ulink url="http://www.ioplex.com/d/Jespa_Overview.pdf?ts=1337127161">http://www.ioplex.com/d/Jespa_Overview.pdf?ts=1337127161</ulink>).  Например:</para>
          <para><prompt>jespa.log.level=3</prompt></para>
        </listitem>
        <listitem>
          <para>Установить в <glossterm linkend="glossary_local_app_properties">local.app.properties</glossterm> переменную <prompt>cuba.web.useActiveDirectory=true</prompt></para>
        </listitem>
        <listitem>
          <para>Добавить адрес сервера в местную интрасеть в настройках браузера:</para>
          <para><prompt>Для IE и Chrome: Свойства обозревателя-Безопасность-Местная интрасеть-Узлы-Дополнительно</prompt></para>
          <para><prompt>Для FF: url=about:config, filter=ntlm, network.automatic-ntlm-auth.trusted-uris=vm30,http://tezis.haulmont.com (пример)</prompt></para>
        </listitem>
      </itemizedlist>
    </section>
  </section>
</chapter>
