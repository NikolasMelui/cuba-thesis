<?xml version='1.0' encoding='UTF-8'?>
<!-- This document was created with Syntext Serna Free. --><chapter id="chapter0_theoretical_info" lang="ru">
  <title>Общие сведения</title>
  <para>В платформе <application>CUBA</application> существует подсистема безопасности. Подсистема  устроена так, что ограничению и защите подлежит не только информация, но и дизайн  системы. Настройки подсистемы безопасности можно свободно изменять. Это право предоставлено администраторам системы. </para>
  <para>Для работы технологии разграничения прав доступа используется аутентификация. Для этого система использует такое понятие, как учетная запись пользователя, которая состоит из открытого имени пользователя и зашифрованного пароля. При выполнении процедуры идентификации пользователь вводит свое имя и пароль, которые затем проверяются подсистемой безопасности на корректность. Если введенный для выбранного имени пользователя пароль оказался верным, то система считает, что процедура аутентификации пройдена успешно.</para>
  <para>При доступе к БД система проверяет, имеется ли у текущего пользователя необходимые права на ту информацию, которую он запрашивает. В случае положительного решения информация предоставляется пользователю. В случае отрицательного решения пользователю в доступе отказывается.</para>
  <para>Основные компоненты подсистемы безопасности <application>CUBA</application>  приведены на
следующей диаграмме. </para>
  <mediaobject>
    <imageobject>
      <imagedata align="center" fileref="img/Security.png"/>
    </imageobject>
  </mediaobject>
  <para>Рассмотрим их более подробно. </para>
  <section>
    <title>Platform security dependent code</title>
  </section>
  <section>
    <title>Application security dependent code</title>
  </section>
  <section>
    <title>Login screen</title>
    <para><classname>Login screen</classname> представляет собой окно входа в систему, посредством которого пользователь получает доступ к системе. В этом окне производится аутентификация пользователя по логину и паролю, а также дальнейшая авторизация. Пароль в целях его безопасности хранится в базе данных в хэшированном виде.</para>
    <mediaobject>
      <imageobject>
        <imagedata align="center" fileref="img/loginWindow.png"/>
      </imageobject>
    </mediaobject>
    <para>Класс окна входа в систему − <classname>LoginWindow</classname>. </para>
  </section>
  <section>
    <title>User Session</title>
    <para>Пользовательская сессия (User Session) –  центральный элемент обеспечения безопасности, 
объект,  ассоциированный с аутентифицированным в данный момент в системе 
пользователем,  и содержащий информацию о правах доступа пользователя к
данным.</para>
    <para>Для контроля прав доступа пользователей к данным код системы всегда должен иметь возможность узнать, какой пользователь в данный момент работает и каковы его права. Например, перед сохранением сущности в БД в специальных полях сущности проставляется имя пользователя, выполняющего сохранение. Кроме того, <glossterm linkend="glossary_dataService_id">Data Service</glossterm> всегда проверяет права пользователя на извлечение или сохранение определенных сущностей.</para>
    <para>Информация о текущем пользователе и его правах хранится в объекте <classname>UserSession</classname>, который создается после входа  пользователя и кэшируется на стороне <glossterm linkend="glossary_middleware_id">middleware</glossterm>, а также передается клиенту в результате метода <methodname>LoginService.login()</methodname>. Уничтожается пользовательская сессия после выхода пользователя из системы, либо после истечения времени бездействия, определяемого параметром среднего слоя приложения <parameter>cuba.userSessionExpirationTimeoutSec</parameter> (смотрите класс конфигурации <classname>ServerConfig.getUserSessionExpirationTimeoutSec</classname>).</para>
    <para>Текущая пользовательская сессия всегда привязывается к потоку выполнения и может быть получена следующими способами:<itemizedlist>
        <listitem>
          <para>через интерфейс инфраструктуры <classname>UserSessionSource</classname></para>
        </listitem>
        <listitem>
          <para>через статический фасад <classname>UserSessionProvider</classname></para>
        </listitem>
      </itemizedlist></para>
    <para>Кроме получения информации о пользователе объект сессии позволяет проверить наличие прав на некоторый объект системы. Делается это вызовом методов <methodname>isScreenPermitted()</methodname>, <methodname>isEntityOpPermitted()</methodname> и другими.</para>
    <para>Список активных пользовательских сессий можно получить на клиенте через сервис <classname>UserSessionService</classname>,  в JMX интерфейсе через МБин <classname>app.cuba:service=UserSessions</classname>, а также с помощью подпункта меню <guimenu>Администрирование</guimenu> −&gt; <guimenu>Пользовательские сессии</guimenu>.</para>
    <mediaobject>
      <imageobject>
        <imagedata align="center" fileref="img/usesrSession.png"/>
      </imageobject>
    </mediaobject>
  </section>
  <section>
    <title>Roles</title>
    <para>Роль − это объект системы, которому с одной стороны сопоставляется набор полномочий, необходимых для выполнения конкретных функций, а с другой стороны − подмножество пользователей, которые должны иметь эти полномочия.</para>
    <para>Пользователь получает логическую сумму прав на некоторый объект от всех ролей, которые у него есть. При этом если ни одна роль не определяет явно право на объект, то пользователь получает право на этот объект. Таким образом,  пользователь имеет права на все объекты, на которые либо ни одна роль явно не определяет право, либо хотя бы одна роль определяет, что право есть. Отсюда следует, что если пользователю дать единственную роль без явно установленных прав, то у него будут все права на все объекты.</para>
    <para>Для роли возможно указание одного из следующих типов:<itemizedlist>
        <listitem>
          <para><emphasis role="bold">STANDARD</emphasis> − в роли данного типа действуют только явно назначенные разрешения.</para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">SUPER</emphasis> − роль данного типа автоматически дает все разрешения. Это удобно для назначения администраторов системы.</para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">READONLY</emphasis> − роль данного типа автоматически отнимает разрешения на следующие операции с сущностями: CREATE, UPDATE, DELETE.</para>
        </listitem>
        <listitem>
          <para><emphasis role="bold">DENYING</emphasis> − роль данного типа автоматически отнимает разрешения на все объекты, кроме атрибутов сущностей.</para>
        </listitem>
      </itemizedlist></para>
    <mediaobject>
      <imageobject>
        <imagedata align="center" fileref="img/permissions.png"/>
      </imageobject>
    </mediaobject>
    <para>Путем задания для пользователя набора ролей в экранах управления подсистемой безопасности осуществляется настройка прав доступа. Набор ролей определяет эффективный набор разрешений следующих типов: <itemizedlist id="permissions_types_id">
        <listitem>
          <para>Возможность открытия некоторого экрана (Screen Permissions)</para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/screenPermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
        <listitem>
          <para>Возможность операции над некоторой сущностью:  чтение,  создание, 
модификация, удаление (Entity Operation Permissions)</para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/entityoperationPermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
        <listitem>
          <para>Доступ к произвольному атрибуту некоторой сущности:  модификация, 
только чтение, нет доступа (Entity Attribute Permissions)</para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/entityattributePermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
        <listitem>
          <para>Разрешение на некоторую именованную функциональность (Specific Permissions)</para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/specificpermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
        <listitem>
          <para>Управление доступом к конкретным элементам экрана (Interface Permissions)</para>
          <mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/interfacePermissions.png"/>
            </imageobject>
          </mediaobject>
        </listitem>
      </itemizedlist></para>
  </section>
  <section>
    <title>Access Groups</title>
    <para>Группа доступа задает набор ограничений,  позволяющих контролировать
доступ на уровне отдельных экземпляров (строк таблицы)  некоторой сущности. 
Например, пользователь видит только те документы, которые были созданы в его
отделе.</para>
    <para><emphasis role="bold">Constraints</emphasis></para>
    <para>В параметрах ограничений (constraints) можно использовать следующие предопределенные константы:<itemizedlist>
        <listitem>
          <para><varname>session$userLogin</varname> − логин текущего пользователя (всегда того, кто залогинен, независимо от замещения).</para>
        </listitem>
        <listitem>
          <para><varname>session$userId</varname> − ID текущего пользователя (всегда того, кто залогинен, независимо от замещения).</para>
        </listitem>
        <listitem>
          <para><varname>session$userGroupId</varname> − ID группы текущего пользователя (того, кто залогинен, либо замещаемого, если таковой выбран).</para>
        </listitem>
        <listitem>
          <para><varname>session$XXX</varname> − атрибут текущей пользовательской сессии, где XXX - имя атрибута</para>
        </listitem>
      </itemizedlist></para>
    <mediaobject>
      <imageobject>
        <imagedata align="center" fileref="img/accessGroups.png"/>
      </imageobject>
    </mediaobject>
    <para>Следует иметь в виду следующие моменты:<itemizedlist>
        <listitem>
          <para>при задании только оператора Where в нем заменяется алиас основной сущности;</para>
        </listitem>
        <listitem>
          <para>при задании и оператора Join, и оператора Where, в операторе Join алиас заменяется, а в операторе Where нет.</para>
        </listitem>
      </itemizedlist></para>
    <para>В обоих случаях в текст оператора Join и оператора Where можно помещать метку {E}, которая будет заменена на алиас основной сущности запроса. Если в тексте встречается метка {E}, то никаких других алиасов, кроме указанных меткой, заменяться не будет.</para>
    <para><emphasis role="bold">Session Attributes</emphasis></para>
    <para>Атрибуты пользовательской сессии могут быть заданы при настройке системы. Это может понадобиться при настройке constraints, а также для любой другой прикладной функциональности.</para>
    <para>В пользовательскую сессию при логине будут помещены все атрибуты, заданные для группы, в которой находится пользователь, и для всех родительских групп вверх по иерархии. При этом если атрибут встречается в иерархии групп несколько раз, значение он получит от самой верхней группы, то есть переопределение значений атрибутов на нижнем уровне невозможно. При попытке переопределения в лог сервера будет выведено сообщение с уровнем WARN.</para>
  </section>
  <section>
    <title>Ограничение входа по IP</title>
    <para>Для пользователя может быть задана маска допустимых IP-адресов, с которых возможен вход в систему.</para>
    <para>Маска представляет собой список адресов через запятую. Каждый адрес должен обязательно состоять из 4-х чисел разделенных точками (обычный формат IPv4). При этом любая часть вместо числа может содержать знак &quot;*&quot;, что означает &quot;любое число&quot;.</para>
    <mediaobject>
      <imageobject>
        <imagedata align="center" fileref="img/IPpermissions.png"/>
      </imageobject>
    </mediaobject>
    <para>Если маска задана неправильно, либо для данного соединения не может быть определен адрес в формате IPv4, в лог выводится сообщение от логгера <classname>IpMatcher</classname>, и вход при этом разрешается.</para>
  </section>
</chapter>
