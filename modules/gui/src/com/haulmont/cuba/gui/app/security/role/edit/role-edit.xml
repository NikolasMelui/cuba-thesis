<!--
  ~ Copyright (c) 2011 Haulmont Technology Ltd. All Rights Reserved.
  ~ Haulmont Technology proprietary and confidential.
  ~ Use is subject to license terms.
  -->

<window
        xmlns="http://www.haulmont.com/schema/cuba/gui/window.xsd"
        datasource="role"
        caption="msg://caption"
        class="com.haulmont.cuba.gui.app.security.role.edit.RoleEditor"
        messagesPack="com.haulmont.cuba.gui.app.security.role.edit"
        >

    <metadataContext>
        <deployViews name="/com/haulmont/cuba/gui/app/security/role/role.views.xml"/>
    </metadataContext>

    <dsContext>
        <datasource
                id="role"
                class="com.haulmont.cuba.security.entity.Role"
                view="_local"
                >
            <!--<collectionDatasource id="permissions" property="permissions"/>-->
        </datasource>

        <collectionDatasource
                id="entity-permissions"
                class="com.haulmont.cuba.security.entity.Permission"
                view="role.edit"
                >
            <query>select p from sec$Permission p where p.role.id = :ds$role and p.type = 20</query>
        </collectionDatasource>

        <collectionDatasource
                id="property-permissions"
                class="com.haulmont.cuba.security.entity.Permission"
                view="role.edit"
                >
            <query>select p from sec$Permission p where p.role.id = :ds$role and p.type = 30</query>
        </collectionDatasource>

        <collectionDatasource
                id="screen-permissions"
                class="com.haulmont.cuba.security.entity.Permission"
                view="role.edit"
                >
            <query>select p from sec$Permission p where p.role.id = :ds$role and p.type = 10</query>
        </collectionDatasource>

        <collectionDatasource
                id="specific-permissions"
                class="com.haulmont.cuba.security.entity.Permission"
                view="role.edit"
                >
            <query>select p from sec$Permission p where p.role.id = :ds$role and p.type = 40</query>
        </collectionDatasource>

        <collectionDatasource
                id="screen-permissions-tree-ds"
                class="com.haulmont.cuba.gui.config.PermissionConfig$Target"
                view="_local"
                >
            <datasourceClass>com.haulmont.cuba.gui.security.ScreenPermissionTreeDatasource</datasourceClass>
        </collectionDatasource>
    </dsContext>

    <#assign width = 200>
    <#assign widthPPB = 120>
    <#assign widthPPBMenu = 100>
    <layout expandLayout="true" expand="main">
        <vbox id="main" spacing="true" expand="permissions-types">
            <hbox spacing="true" margin="true" width="100%" expand="descrBox"
                  stylename="edit-area">
                <grid spacing="true">
                    <columns>
                        <column/>
                        <column/>
                        <column/>
                    </columns>
                    <rows>
                        <row>
                            <label value="msg://name"/>
                            <textField id="name" datasource="role" property="name" width="${width}" required="true"
                                       requiredMessage="msg://nameMsg"/>
                        </row>
                        <row>
                            <label value="msg://locName"/>
                            <textField id="locName" datasource="role" property="locName" width="${width}"/>
                        </row>
                    </rows>
                </grid>

                <grid spacing="true">
                    <columns>
                        <column/>
                        <column/>
                        <column/>
                    </columns>
                    <rows>
                        <row>
                            <label value="msg://superRole"/>
                            <checkBox id="superRole" datasource="role" property="superRole"/>
                        </row>
                        <row>
                            <label value="msg://defaultRole"/>
                            <checkBox id="defaultRole" datasource="role" property="defaultRole"/>
                        </row>
                    </rows>
                </grid>

                <hbox spacing="true" id="descrBox" expand="description;width=300px;height=100%">
                    <label value="msg://description"/>
                    <textField id="description" datasource="role" property="description" rows="4"/>
                </hbox>
            </hbox>

            <tabsheet id="permissions-types">
                <tab id="screen-permissions-tab" caption="msg://screen-permissions">
                    <vbox expand="screen-permissions-tree" margin="true" spacing="true">
                        <buttonsPanel>
                            <popupButton id="screen-permissions-grant" icon="icons/add.png"
                                     caption="msg://permissions.grant"
                                     width="${widthPPB}" menuWidth="${widthPPBMenu}"/>
                        </buttonsPanel>

                        <treeTable id="screen-permissions-tree">
                            <columns>
                                <column id="caption" caption="msg://target"/>
                                <column id="permissionVariant" caption="msg://value"/>
                            </columns>
                            <rows datasource="screen-permissions-tree-ds"/>
                        </treeTable>
                    </vbox>
                </tab>
                <tab id="entity-permissions-tab" caption="msg://entity-permissions" lazy="true">
                    <vbox expand="entity-permissions" margin="true" spacing="true">
                        <buttonsPanel>
                            <popupButton id="entity-permissions-grant" icon="icons/add.png"
                                         caption="msg://permissions.grant"
                                         width="${widthPPB}" menuWidth="${widthPPBMenu}"/>
                            <button id="entity-permissions-remove" action="entity-permissions.remove"
                                    caption="msg://permissions.remove" icon="icons/remove.png"/>
                        </buttonsPanel>
                        <table id="entity-permissions">
                            <columns>
                                <column id="target" caption="msg://target"/>
                                <column id="value" caption="msg://value"/>
                            </columns>
                            <rows datasource="entity-permissions"/>
                        </table>
                    </vbox>
                </tab>
                <tab id="property-permissions-tab" caption="msg://property-permissions" lazy="true">
                    <vbox expand="property-permissions" margin="true" spacing="true">
                        <buttonsPanel>
                            <popupButton id="property-permissions-grant" icon="icons/add.png"
                                         caption="msg://permissions.grant"
                                         width="${widthPPB}" menuWidth="${widthPPBMenu}"/>
                            <button id="property-permissions-remove" action="property-permissions.remove"
                                    caption="msg://permissions.remove" icon="icons/remove.png"/>
                        </buttonsPanel>
                        <table id="property-permissions">
                            <columns>
                                <column id="target" caption="msg://target"/>
                                <column id="value" caption="msg://value"/>
                            </columns>
                            <rows datasource="property-permissions"/>
                        </table>
                    </vbox>
                </tab>
                <tab id="specific-permissions-tab" caption="msg://specific-permissions" lazy="true">
                    <vbox expand="specific-permissions" margin="true" spacing="true">
                        <buttonsPanel>
                            <popupButton id="specific-permissions-grant" icon="icons/add.png"
                                         caption="msg://permissions.grant"
                                         width="${widthPPB}" menuWidth="${widthPPBMenu}"/>
                            <button id="specific-permissions-remove" action="specific-permissions.remove"
                                    caption="msg://permissions.remove" icon="icons/remove.png"/>
                        </buttonsPanel>
                        <table id="specific-permissions">
                            <columns>
                                <column id="target" caption="msg://target"/>
                                <column id="value" caption="msg://value"/>
                            </columns>
                            <rows datasource="specific-permissions"/>
                        </table>
                    </vbox>
                </tab>
            </tabsheet>
        </vbox>
        <iframe id="windowActions" src="/com/haulmont/cuba/gui/edit-window.actions.xml"/>
    </layout>
</window>
