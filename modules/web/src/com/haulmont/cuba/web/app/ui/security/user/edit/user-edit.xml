<window
        xmlns="http://www.haulmont.com/schema/cuba/gui/window.xsd"
        datasource="user"
        caption="msg://caption"
        class="com.haulmont.cuba.web.app.ui.security.user.edit.UserEditor"
        messagesPack="com.haulmont.cuba.web.app.ui.security.user.edit"
        >
    <metadataContext>
        <deployViews name="/com/haulmont/cuba/web/app/ui/security/user/user.views.xml"/>
        <deployViews name="/com/haulmont/cuba/web/app/ui/security/group/group.views.xml"/>
    </metadataContext>

    <dsContext>
        <datasource
                id="user"
                class="com.haulmont.cuba.security.entity.User"
                view="user.edit">
            <collectionDatasource id="roles" property="userRoles"/>
            <collectionDatasource id="substitutions" property="substitutions"/>
        </datasource>

        <collectionDatasource
                id="groups"
                class="com.haulmont.cuba.security.entity.Group"
                view="group.lookup"
                >
            <query>select g from sec$Group g</query>
        </collectionDatasource>

        <!--<collectionDatasource id="substitution"-->
                              <!--class="com.haulmont.cuba.security.entity.UserSubstitution"-->
                              <!--view="user.edit">-->
            <!--<query>select us from sec$UserSubstitution us where us.user.id = :ds$user</query>-->
        <!--</collectionDatasource>-->
    </dsContext>

    <#assign width=250>
    <layout>
        <vbox expand="split" spacing="true">
            <hbox spacing="true" margin="true" width="100%" stylename="edit-area">
                <grid spacing="true" expandable="false">
                    <columns>
                        <column flex="1"/>
                        <column flex="1"/>
                    </columns>
                    <rows>
                        <row>
                            <vbox align="MIDDLE_RIGHT">
                                <label value="msg://login"/>
                            </vbox>
                            <textField id="login" datasource="user" property="login" width="${width}" required="true"/>
                        </row>
                        <row visible="PersistenceHelper.isNew(param_item)">
                            <vbox align="MIDDLE_RIGHT">
                                <label id="passwLab" value="msg://password"/>
                            </vbox>
                            <textField id="passw" secret="true" width="${width}" required="true"/>
                        </row>
                        <row visible="PersistenceHelper.isNew(param_item)">
                            <vbox align="MIDDLE_RIGHT">
                                <label id="confirmPasswLab" value="msg://confirmPassword"/>
                            </vbox>
                            <textField id="confirmPassw" secret="true" width="${width}"/>
                        </row>
                        <row>
                            <vbox align="MIDDLE_RIGHT">
                                <label value="msg://name"/>
                            </vbox>
                            <textField id="name" datasource="user" property="name" width="${width}"/>
                        </row>
                        <row>
                            <vbox align="MIDDLE_RIGHT">
                                <label value="msg://email"/>
                            </vbox>
                            <textField id="email" datasource="user" property="email" width="${width}">
                                <validator
                                        class="com.haulmont.cuba.gui.components.validators.EmailValidator"
                                        message="msg://email.alert"/>
                            </textField>
                        </row>
                        <row>
                            <vbox align="MIDDLE_RIGHT">
                                <label value="msg://group"/>
                            </vbox>
                            <lookupField id="group" datasource="user" property="group" captionProperty="name"
                                         optionsDatasource="groups" width="${width}"/>
                        </row>
                    </rows>
                </grid>
                <grid spacing="true" expandable="false">
                    <columns>
                        <column flex="1"/>
                        <column flex="1"/>
                    </columns>
                    <rows>
                        <row>
                            <vbox align="MIDDLE_RIGHT">
                                <label value="msg://lastName"/>
                            </vbox>
                            <textField id="lastName" datasource="user" property="lastName" width="${width}"/>
                        </row>
                        <row>
                            <vbox align="MIDDLE_RIGHT">
                                <label value="msg://firstName"/>
                            </vbox>
                            <textField id="firstName" datasource="user" property="firstName" width="${width}"/>
                        </row>
                        <row>
                            <vbox align="MIDDLE_RIGHT">
                                <label value="msg://middleName"/>
                            </vbox>
                            <textField id="middleName" datasource="user" property="middleName" width="${width}"/>
                        </row>
                        <row>
                            <vbox align="MIDDLE_RIGHT">
                                <label value="msg://position"/>
                            </vbox>
                            <textField id="position" datasource="user" property="position" width="${width}"/>
                        </row>
                    </rows>
                </grid>
                <hbox spacing="true">
                    <label value="msg://active"/>
                    <checkBox id="active" datasource="user" property="active"/>
                </hbox>
                <hbox align="TOP_RIGHT" spacing="true">
                    <label value="msg://permissions"/>
                    <lookupField id="permissionsLookupField"/>
                </hbox>
            </hbox>

            <split id="split" orientation="horizontal" pos="50">
                <vbox id="roles-panel" expand="roles" spacing="true" margin="false;true;false;true">
                    <label value="msg://roles" stylename="h2"/>
                    <hbox align="MIDDLE_LEFT" spacing="true">
                        <button action="roles.add" icon="icons/add.png"/>
                        <button action="roles.remove" icon="icons/remove.png"/>
                    </hbox>
                    <table id="roles" editable="false">
                        <columns>
                            <column id="role" caption="msg://roleName" captionProperty="name" clickAction="open:sec$Role.edit"/>
                            <column id="role.locName" caption="msg://localizedRoleName"/>
                        </columns>
                        <rows datasource="roles"/>
                    </table>
                </vbox>

                <vbox id="subst-panel" expand="subst" spacing="true" margin="false;true;false;true">
                    <label value="msg://substUsers" stylename="h2"/>
                    <hbox align="MIDDLE_LEFT" spacing="true">
                        <button action="subst.add" icon="icons/add.png"/>
                        <button action="subst.edit" icon="icons/edit.png"/>
                        <button action="subst.remove" icon="icons/remove.png"/>
                    </hbox>
                    <table id="subst" editable="false">
                        <columns>
                            <column id="substitutedUser.login" caption="msg://login"/>
                            <column id="substitutedUser.name" caption="msg://name"/>
                            <column id="endDate" caption="msg://endDate">
                                <formatter class="com.haulmont.cuba.gui.components.formatters.DateFormatter" format="dd/MM/yyyy"/>
                            </column>
                        </columns>
                        <rows datasource="substitutions"/>
                    </table>
                </vbox>
            </split>

            <iframe id="windowActions" src="/com/haulmont/cuba/gui/edit-window.actions.xml"/>
        </vbox>
    </layout>
</window>
